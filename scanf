#include <stdio.h>
#include <stdarg.h>

static int pushed_char = -1;
int read_char(void) {
    if (pushed_char != -1) {
        int c = pushed_char;
        pushed_char = -1;   // reset global variable
        return c;
    }
    return getchar();
}

void unread_char(int c) {
    pushed_char = c;
}

//ignore whitespace
void skip_whitespaces(void) {
    int c;
    while ((c = read_char()) != EOF) {
        if (!(c==' ' || c=='\t' || c=='\n' || c=='\r' || c=='\v' || c=='\f')) {
            unread_char(c);
            return;
        }
    }
}

// %d reading a decimal integer
int read_decimal(int *out) {
    int c;
    int sign = 1;
    int value = 0;
    int digits_read = 0;

    skip_whitespaces();

    c = read_char();
    if (c == '-') {
        sign = -1;
    } else if (c == '+') {
        sign = 1;
    } else {
        unread_char(c);
    }

    while ((c = read_char()) != EOF) {
        if (c >= '0' && c <= '9') {
            value = value * 10 + (c - '0');
            digits_read++;
        } else {
            unread_char(c);
            break;
        }
    }

    if (digits_read == 0) {
        return 0;   // failure
    }

    *out = sign * value;
    return 1;       // success
}
// read a single char %c
int read_char_specifier(char *out) {
    int c = read_char();
    if (c == EOF) return 0;  // fail
    *out = c;
    return 1;                // success
}

// read a string %s
int read_string(char *out) {
    int c;
    skip_whitespaces();  // skip leading spaces

    int len = 0;
    while ((c = read_char()) != EOF && c != ' ' && c != '\n' && c != '\t') {
        out[len++] = c;
    }
    out[len] = '\0';
    return len > 0;  // success if at least 1 char read
}

int read_hex(int *out) {
    int c;
    int sign = 1;
    int value = 0;
    int digits_read = 0;
    int digit;

    skip_whitespaces();

    c = read_char();
    if (c == '-') {
        sign = -1;
    } else if (c == '+') {
        sign = 1;
    } else {
        unread_char(c);
    }

    while ((c = read_char()) != EOF) {
        if (c >= '0' && c <= '9') {
            digit = c - '0';
        }
        else if (c >= 'A' && c <= 'F') {
            digit = c - 'A' + 10;
        }
        else if (c >= 'a' && c <= 'f') {
            digit = c - 'a' + 10;
        }
        else {
            unread_char(c);
            break;
        }

        value = value * 16 + digit;
        digits_read++;
    }

    if (digits_read == 0) {
        return 0;
    }

    *out = sign * value;
    return 1;
}

int read_float(float *out) {
    int c;
    int sign = 1;
    float value = 0.0f;
    int digits_read = 0;

    skip_whitespaces();

    c = read_char();
    if (c == '-') sign = -1;
    else if (c == '+') sign = 1;
    else unread_char(c);

    // integer part
    while ((c = read_char()) != EOF && c >= '0' && c <= '9') {
        value = value * 10.0f + (c - '0');
        digits_read++;
    }

    // fractional part
    if (c == '.') {
        float fraction = 0.0f;
        float factor = 0.1f;
        int fraction_digits = 0;
        while ((c = read_char()) != EOF && c >= '0' && c <= '9') {
            fraction += (c - '0') * factor;
            factor *= 0.1f;
            digits_read++;
            fraction_digits++;
        }
        value += fraction;


        // if no digits after decimal, fail
        if (fraction_digits == 0 && digits_read == 0) {
            if (c != EOF) unread_char(c);
            return 0;

        }
    }

    if (c == 'e' || c == 'E') {
        int exponent_sign = 1;
        int exponent_digits = 0;
        int exponent_value = 0;

        c = read_char();
        if (c == '-') exponent_sign = -1;
        else if (c == '+') exponent_sign = 1;
        else unread_char(c);

        while ((c = read_char()) != EOF && c >= '0' && c <= '9') {
            exponent_value = exponent_value * 10 + (c - '0');
            exponent_digits++;
        }
        if (exponent_digits == 0) {
            if (c != EOF) unread_char(c);
            return 0;
        }
        if (c != EOF) unread_char(c);

        // apply exponent
        float factor = 1.0f;
        for (int i = 0; i < exponent_value; i++) factor *= 10.0f;
        if (exponent_sign == 1) value *= factor;
        else value /= factor;
    }

        *out = sign * value;
        return 1;
}

//--------------------------------------------------//
//new custom modifiers//
//read binary number %b //

int read_binary(int *out) {
    int c;
    int sign = 1;
    int value = 0;
    int digits_read = 0;
    skip_whitespaces();

    c = read_char();
    if (c == '-') sign = -1;
    else if (c == '+') sign = 1;
    else unread_char(c);
    while ((c = read_char()) != EOF) {
        if ( c == '0' || c == '1') {
            value = value * 2 + (c - '0');
            digits_read++;
        }else {
            unread_char(c);
            break;
        }
    }
    if (digits_read == 0) return 0;
    *out = sign * value;
    return 1; //success
}

int read_line(char *out, int max_size) {
    char c;
    int index = 0;
    while (EOF != (c = read_char()) && c != '\n') {
        if (index < max_size - 1){
            out[index] = c;
            index++;
        }
    }
    out[index] = '\0';
    if (index == 0 && c == EOF) return 0;
    return 1;
}
int my_scanf(const char *fmt, ...){
    va_list args;
    int assigned = 0;
    va_start(args, fmt);

    //deal with leading spaces
    if (*fmt == ' ') {
        skip_whitespaces();
        fmt++;
    }
    if (*fmt == '%' && *(fmt + 1) == 'd') {
        int *ptr = va_arg(args, int *);
        if (read_decimal(ptr)) {
            assigned = 1;
        }
    }
    else if (*fmt == '%' && *(fmt + 1) == 'c') {
        char *ptr = va_arg(args, char *);
        if (read_char_specifier(ptr)) {
            assigned = 1;
        }
    }
    else if (*fmt == '%' && *(fmt + 1) == 's') {
        char *ptr = va_arg(args, char *);
        if (read_string(ptr)) assigned = 1;
    }
    else if (*fmt == '%' && *(fmt + 1) == 'x') {
        int *ptr = va_arg(args, int *);
        if (read_hex(ptr)) assigned = 1;
    }
    else if (*fmt == '%' && *(fmt + 1) == 'f') {
        float *ptr = va_arg(args, float *);
        if (read_float(ptr)) assigned = 1;
    }

    else if (*fmt == '%' && *(fmt + 1) == 'b') {
        int *ptr = va_arg(args, int *);
        if (read_binary(ptr)) {
            assigned = 1;
        }
    }
    else if (*fmt == '%' && *(fmt + 1) == 'L') {
        char *ptr = va_arg(args, char *);
        int max_size = va_arg(args, int);
        if (read_line(ptr, max_size)) {
            assigned = 1;
        }
    }
    va_end(args);
    return assigned;
}

    //test
    int main(void){
    int x;
    char ch;
    char str[100];  // buffer to store the string
    float f;
    int b;
    char line[100];

    // test L line %L
    if (my_scanf("%L", &line, 100) == 1) {
        printf("you entered a line: %s\n", line);
    } else {
        printf("Invalid line input\n");
    }
    // test binary %b
    if (my_scanf("%b", &x) == 1) {
        printf("Binary input as decimal: %d\n", x);
    } else {
        printf("Invalid binary input\n");
    }

    //test float %f
    if (my_scanf("%f", &f) == 1) {
        printf("You entered a float: %f\n", f);
    } else {
        printf("Invalid float input\n");
    }

    // Test %x
    int hex;
    if (my_scanf("%x", &hex) == 1) {
        printf("You entered a hex number: %X\n", hex); // print as hex
        printf("Decimal value: %d\n", hex);
    } else {
        printf("Invalid hex input\n");
    }

    // Test %d
    if (my_scanf("%d", &x) == 1) {
        printf("You entered an integer: %d\n", x);
    } else {
        printf("Invalid integer input\n");
    }

    // Test %c
    if (my_scanf("%c", &ch) == 1) {
        printf("You entered a character: '%c'\n", ch);
    } else {
        printf("Invalid character input\n");
    }

    // Test %s
    if (my_scanf("%s", str) == 1) {
        printf("You entered a string: \"%s\"\n", str);
    } else {
        printf("Invalid string input\n");
    }


    return 0;
}




